<script>
  let localHour = NaN;

  //TODO, remove for production
  function SetTime(date)
  {
    let localTime = new Date(date);
    localHour = localTime.getHours();
  }

  //Avoid 3.4-1.6 = 1.79999999999
  function javascriptRound(num)
  {
    return Math.round(num*100000000)/100000000;
  }


  //Store machine's stored items, balance and total funds
  class VendingMachine
  {
    constructor(stock) {
      this.stock = stock;

      //Store current balance
      this.balance = 0;
      //Store money from sold items
      this.fund = 0;

      this.logs = [];
    }

    //Add money to thet balance
    Insert(amount)
    {
      this.balance+=amount;
    }

    //Try to sell an item
    Choose(code)
    {
      //Existing item verificatiom
      if(this.stock[code] !== undefined)
      {
        //Enough quantity verification
        if(this.stock[code].qty > 0)
        {
          //Enough balance for price verification
          if(this.balance >= this.stock[code].item.price)
          {
            this.stock[code].qty -= 1;

            //Reduce balance and increase fund with item price
            this.balance = javascriptRound(this.balance - this.stock[code].item.price);
            this.fund = javascriptRound(this.fund + this.stock[code].item.price);

            //Check if a custom hour is set
            let useHour = isNaN(localHour) ? (new Date).getHours() : localHour;

            //Get log entry for this hour, equal -1 if not exists
            let hourIndex = this.logs.findIndex(function(val) {return val['hour'] == useHour});

            //If this hour already has an log entry
            if(hourIndex != -1)
            {
              this.logs[hourIndex]['amount'] = javascriptRound(this.logs[hourIndex]['amount'] + this.stock[code].item.price);
            }
            //Else, create log entry
            else
            {
              this.logs.push({hour: useHour, amount: this.stock[code].item.price});
            }

            return "Vending "+this.stock[code].item.name;
          }
          else
          {
            return "Not enough money!";
          }
        }
        else
        {
          return "Item "+this.stock[code].item.name+": Out of stock!";
        }
      }
      else
      {
        return "Invalid selection!";
      }
    }

    //Return current balance
    GetChange()
    {
      return this.balance;
    }

    //Return total price of sold items
    GetBalance()
    {
      return this.fund;
    }

    GetLogs()
    {
      let display = this.logs;
      display.sort(function(a, b) {return a['amount'] < b['amount']});
      display = display.slice(0, 3);

      display.forEach(function(val) {console.log("Hour " + val['hour'] + " generated a revenue of " + val['amount'])});
      //console.log(display);
    }
  }

  //Store an item's name and price
  class Item
  {
    constructor(name, price) {
      this.name = name;
      this.price = price;
    }
  }


  //Test machine
  newStock = [];
  newStock["A01"] = {"item": new Item("Smarties", 1.6), "qty": 10};
  newStock["A02"] = {"item": new Item("Carampar", 0.6), "qty": 5};
  newStock["A03"] = {"item": new Item("Avril", 2.1), "qty": 2};
  newStock["A04"] = {"item": new Item("KokoKola", 2.95), "qty": 1};

  machine1 = new VendingMachine(newStock);


  //Test machine extension
  newStock = [];
  newStock["A01"] = {"item": new Item("Smarties", 1.6), "qty": 100};
  newStock["A02"] = {"item": new Item("Carampar", 0.6), "qty": 50};
  newStock["A03"] = {"item": new Item("Avril", 2.1), "qty": 20};
  newStock["A04"] = {"item": new Item("KokoKola", 2.95), "qty": 10};

  machineExtension = new VendingMachine(newStock);


  //Tests cases
  switch(-1)
  {
    case 0:
    machine1.Insert(3.40);
    console.log(machine1.Choose("A01"));
    console.log(machine1.GetChange());
    break;

    case 1:
    machine1.Insert(2.10);
    console.log(machine1.Choose("A03"));
    console.log(machine1.GetChange());
    console.log(machine1.GetBalance());
    break;

    case 2:
    console.log(machine1.Choose("A01"));
    break;

    case 3:
    machine1.Insert(1.00);
    console.log(machine1.Choose("A01"));
    console.log(machine1.GetChange());
    console.log(machine1.Choose("A02"));
    console.log(machine1.GetChange());
    break;

    case 4:
    machine1.Insert(1.00);
    console.log(machine1.Choose("A05"));
    break;

    case 5:
    machine1.Insert(6.00);
    console.log(machine1.Choose("A04"));
    console.log(machine1.Choose("A04"));
    console.log(machine1.GetChange());
    break;

    case 6:
    machine1.Insert(6.00);
    console.log(machine1.Choose("A04"));
    machine1.Insert(6.00);
    console.log(machine1.Choose("A04"));
    console.log(machine1.Choose("A01"));
    console.log(machine1.Choose("A02"));
    console.log(machine1.Choose("A02"));
    console.log(machine1.GetChange());
    console.log(machine1.GetBalance());
    break;


    //Extension test case
    case 10:
    machineExtension.Insert(1000.00);
    SetTime("2020-01-01T20:30:00"); machineExtension.Choose("A01");
    SetTime("2020-03-01T23:30:00"); machineExtension.Choose("A01");
    SetTime("2020-03-04T09:22:00"); machineExtension.Choose("A01");
    SetTime("2020-04-01T23:00:00"); machineExtension.Choose("A01");
    SetTime("2020-04-01T23:59:59"); machineExtension.Choose("A01");
    SetTime("2020-04-04T09:12:00"); machineExtension.Choose("A01");
    machineExtension.GetLogs();
    break;

    case 11:
    machineExtension.Insert(1000.00);
    SetTime("2020-04-04T09:12:00"); machineExtension.Choose("A01");

    SetTime("2020-04-04T12:12:00"); machineExtension.Choose("A01");
    SetTime("2020-04-04T12:12:00"); machineExtension.Choose("A01");

    SetTime("2020-01-01T20:30:00"); machineExtension.Choose("A01");
    SetTime("2020-01-01T20:30:00"); machineExtension.Choose("A01");
    SetTime("2020-01-01T20:30:00"); machineExtension.Choose("A01");

    SetTime("2020-03-01T23:30:00");
    machineExtension.Choose("A01");
    machineExtension.Choose("A01");
    machineExtension.Choose("A01");
    machineExtension.Choose("A01");

    machineExtension.GetLogs();
    break;

    case 12:
    machineExtension.Insert(1000.00);

    SetTime("2020-03-01T04:30:00"); machineExtension.Choose("A01");
    SetTime("2020-03-01T04:30:00"); machineExtension.Choose("A01");
    SetTime("2020-04-01T04:00:00"); machineExtension.Choose("A01");
    SetTime("2020-04-01T04:59:59"); machineExtension.Choose("A01");

    SetTime(""); //Use normal hour
    machineExtension.Choose("A01");
    machineExtension.Choose("A01");
    machineExtension.Choose("A01");

    machineExtension.GetLogs();
    break;
  }

</script>
